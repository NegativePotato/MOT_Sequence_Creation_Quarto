---
title: "MOT_Sequence_Creation"
author: "Freya Joessel"
editor: source
date: today
toc: true
toc-depth: 5
# toc-expand: true
number-sections: true
highlight-style: pygments
toc-location: left
reference-location: margin
citation-location: margin
format:
  html: 
    code-fold: true
    html-math-method: katex
---


```{r preamble}
#| echo: false
#| include: false

library(dplyr)
library(progress)
library(ggplot2)
library(purrr)

```

```{r load-data}
#| echo: false
#| cache: true
#| include: false

if (file.exists("Tables/density_per_frame_tables_all.rds")) {
  density_per_frame_tables_all.df <- readRDS(file = "Tables/density_per_frame_tables_all.rds")
} else {
  density_table.df <- read.csv("Tables/density_table.csv", stringsAsFactors = FALSE)
  density_per_frame_table.df <- read.csv("Tables/density_per_frame_table.csv", stringsAsFactors = FALSE)
  
  density_per_frame_tables.list <- list(
    density_per_frame_table.df,
    read.csv("Tables/density_per_frame_table_5678.csv", stringsAsFactors = FALSE),
    read.csv("Tables/density_per_frame_table_2222.csv", stringsAsFactors = FALSE),
    read.csv("Tables/density_per_frame_table_8888.csv", stringsAsFactors = FALSE),
    read.csv("Tables/density_per_frame_table_3995.csv", stringsAsFactors = FALSE))
  
  density_per_frame_tables_2.list <- list(
    read.csv("Tables/density_per_frame_table_3143.csv", stringsAsFactors = FALSE),
    read.csv("Tables/density_per_frame_table_1618.csv", stringsAsFactors = FALSE),
    read.csv("Tables/density_per_frame_table_9876.csv", stringsAsFactors = FALSE),
    read.csv("Tables/density_per_frame_table_9999.csv", stringsAsFactors = FALSE))
  
  density_per_frame_tables_all.list <- 
    c(density_per_frame_tables.list, density_per_frame_tables_2.list)

  for (i_dataset in 1:length(density_per_frame_tables_all.list)) {
    density_per_frame_tables_all.list[[i_dataset]] <-
      density_per_frame_tables_all.list[[i_dataset]] %>% 
      mutate(i_dataset = i_dataset)
  }
  
  density_per_frame_tables_all.df <- bind_rows(density_per_frame_tables_all.list)
    
  saveRDS(object = density_per_frame_tables_all.df, file = "Tables/density_per_frame_tables_all.rds")
}

```

# Task Parameters

```{r task-parameters}
#| echo: false
#| include: false

n_targets_in_experiment <- 5

tracking_duration_s <- 4
trial_duration_s <- 6
probing_duration <- trial_duration_s - tracking_duration_s
trial_n_frames <- max(density_per_frame_tables_all.df$frame_num)
probing_n_frames <- probing_duration*(trial_n_frames - 1)/trial_duration_s + 1
tracking_n_frames <- trial_n_frames - probing_n_frames

```

We opt for N targets to track = `r n_targets_in_experiment` to have enough room above and below the typical performance of young adults at this variant of the MOT task (around 75% - Green and Bavelier (2006)). 

# Investigating Density Values

To define the threshold for low or high density throughout a trial, we compute the median of the density of dots collapsed across trials, frames, and circles. This gives us an empirical estimate of a threshold for the density where 50% of trajectory would be above this threshold and 50% would be above. 

```{r median-density}
#| echo: false
#| include: false

density_threshold <- list()
density_threshold$median <- median(density_per_frame_tables_all.df$density)
density_threshold$sd <- sd(density_per_frame_tables_all.df$density)
density_threshold$mean <- mean(density_per_frame_tables_all.df$density) 
# density_threshold$ci95 <- Hmisc::smean.cl.boot(density_per_frame_table.df$density) 

```

```{r median-density-plot}
#| echo: false
#| include: false

density_hist.plot <- ggplot() +
  geom_histogram(data = density_per_frame_tables_all.df, aes(x = density), bins = 50) + 
  geom_vline(aes(xintercept = density_threshold$median), colour = "red", linetype = "dashed") + 
  geom_vline(aes(xintercept = density_threshold$median - density_threshold$sd), colour = "red", linetype = "dotted") + 
  geom_vline(aes(xintercept = density_threshold$median + density_threshold$sd), colour = "red", linetype = "dotted")

```

```{r median-density-display}
#| echo: false
#| fig-cap: "Density Histogram"
#| cap-location: margin
#| out.width: "70%"
#| fig.align: "center"
#| cache: true

density_hist.plot
```

# Density Low/High Throughout

## Estimating the number of frames

For each existing trajectory, let's estimate for how many frames each dot has a density above the threshold and below the threshold *during the tracking period*. 


```{r n-frames-above-threshold-tracking-period}
#| echo: false
#| include: false
#| cache: true

n_frames_above_threshold.df <- density_per_frame_tables_all.df %>% 
  filter(frame_num > probing_n_frames) %>%
  group_by(trial_num, circle_num) %>% 
  dplyr::summarise(n_frames_above_threshold = sum(density > density_threshold$median)) %>%
  mutate(n_frames_above_threshold_perc = n_frames_above_threshold/max(density_per_frame_tables_all.df$frame_num))

n_frames_above_threshold_hist.plot <- ggplot() + 
  geom_histogram(data = n_frames_above_threshold.df, aes(x = n_frames_above_threshold_perc), bins = 50)

```

```{r n-frames-above-threshold-tracking-period-display}
#| echo: false
#| fig-cap: "Density Histogram"
#| cap-location: margin
#| out.width: "70%"
#| fig.align: "center"
#| cache: true

n_frames_above_threshold_hist.plot
```

Let's confirm that the spikes in the lowest and highest bins actually contains trajectories with all frames either above (1) or below (0) the threshold.

```{r trajectories-above-below-threshold-tracking-period}
#| echo: false
#| include: false

n_trajectories_full_above_or_below.df <- n_frames_above_threshold.df %>%
  ungroup() %>% 
  count(n_frames_above_threshold)

n_full_above <- n_trajectories_full_above_or_below.df %>% 
  filter(n_frames_above_threshold == tracking_n_frames) %>% 
  pull(n)

n_full_below <- n_trajectories_full_above_or_below.df %>% 
  filter(n_frames_above_threshold == 0) %>% 
  pull(n)

```

There are `r n_full_above` trajectories with a density above the threshold at all frames, and `r n_full_below` trajectories with a density below the threshold at all frames. So now we move on to investigating how many trajectories are always under/below the threshold for each trial. 

```{r count-trajectories-tracking-period}
#| echo: false
#| include: false
#| cache: true

n_frames_above_threshold.df <- density_per_frame_tables_all.df %>% 
  filter(frame_num > probing_n_frames) %>%
  group_by(i_dataset, trial_num, circle_num) %>% 
  dplyr::reframe(n_frames_above_threshold = sum(density > density_threshold$median),
                 n_frames_above_threshold_perc = n_frames_above_threshold/n())

n_trajectories_full_above_or_below_per_trial.df <- n_frames_above_threshold.df %>%
  group_by(i_dataset, trial_num) %>% 
  reframe(n_full_above = sum(n_frames_above_threshold_perc == 1),
          n_full_below = sum(n_frames_above_threshold_perc == 0), 
          n_95_above = sum(n_frames_above_threshold_perc >= 0.95),
          n_95_below = sum(n_frames_above_threshold_perc <= 0.05), 
          n_90_above = sum(n_frames_above_threshold_perc >= 0.90),
          n_90_below = sum(n_frames_above_threshold_perc <= 0.10))

trials_to_keep_above.df <-  n_trajectories_full_above_or_below_per_trial.df %>% 
  filter(n_full_above == n_targets_in_experiment)
n_possible_trials_above <- nrow(trials_to_keep_above.df)

trials_to_keep_below.df <-  n_trajectories_full_above_or_below_per_trial.df %>% 
  filter(n_full_below == n_targets_in_experiment)
n_possible_trials_below <- nrow(trials_to_keep_below.df)

write.csv(trials_to_keep_above.df, file = "Tables/trials_to_keep-above_threshold_throughout.csv", row.names = F)
write.csv(trials_to_keep_below.df, file = "Tables/trials_to_keep-below_threshold_throughout.csv", row.names = F)

saveRDS(trials_to_keep_above.df, file = "Tables/trials_to_keep-above_threshold_throughout.rds")
saveRDS(trials_to_keep_below.df, file = "Tables/trials_to_keep-below_threshold_throughout.rds")


# Trials To Keep Above
trials_to_keep_above.str <- paste(trials_to_keep_above.df$i_dataset, 
                                  trials_to_keep_above.df$trial_num, 
                                  sep = "-")

density_per_frame_tables_above_throughout.df <- 
  density_per_frame_tables_all.df %>% 
  mutate(trial_id = paste(i_dataset, trial_num, sep = "-")) %>% 
  filter(trial_id %in% trials_to_keep_above.str)
  
# Trials To Keep Below
trials_to_keep_below.str <- paste(trials_to_keep_below.df$i_dataset, 
                                  trials_to_keep_below.df$trial_num, 
                                  sep = "-")

density_per_frame_tables_below_throughout.df <- 
  density_per_frame_tables_all.df %>% 
  mutate(trial_id = paste(i_dataset, trial_num, sep = "-")) %>% 
  filter(trial_id %in% trials_to_keep_below.str)

write.csv(density_per_frame_tables_above_throughout.df, file = "Tables/density_per_frame_tables_above_throughout.csv", row.names = F)
write.csv(density_per_frame_tables_below_throughout.df, file = "Tables/density_per_frame_tables_below_throughout.csv", row.names = F)

saveRDS(density_per_frame_tables_above_throughout.df, file = "Tables/density_per_frame_tables_above_throughout.rds")
saveRDS(density_per_frame_tables_below_throughout.df, file = "Tables/density_per_frame_tables_below_throughout.rds")



```

## Potential Trials

And here are the trials we can pick from for the "above" and "below" condition trials. There are `r n_possible_trials_above` possible trials for the above condition and `r n_possible_trials_below` for the below condition. 

```{r final-above-trials-tracking-period}
#| echo: false
#| tbl-cap: "Trials for the above condition"  
#| cap-location: top

knitr::kable(trials_to_keep_above.df)
```

```{r final-below-trials-tracking-period}
#| echo: false
#| tbl-cap: "Trials for the below condition"  
#| cap-location: top

knitr::kable(trials_to_keep_below.df)
```

# Low-to-High and High-to-Low Densities

We define out low-to-high trials as trials with a density above the threshold for the initial X seconds of the tracking period and below the threshold for the last X seconds of the tracking period, and vice versa for high-to-low trials. First, we need to understand what value for X makes sense.  

## Estimating the duration for the initial and final periods

```{r low-to-high-density}
#| echo: false
#| include: false
#| cache: true

beginning_period_start_time <- probing_duration
end_period_end_time <- trial_duration_s
frames_per_seconds <- (trial_n_frames - 1)/trial_duration_s

potential_frames.df <- 
  data.frame(potential_period_durations = seq(1, 1.7, 0.05)) %>% 
  mutate(beginning_period_start_frame = beginning_period_start_time*frames_per_seconds + 1,
         beginning_period_end_frame = (potential_period_durations + beginning_period_start_time)*frames_per_seconds + 1,
         end_period_start_frame = (trial_duration_s - potential_period_durations)*frames_per_seconds + 1,
         end_period_end_frame = trial_n_frames,
         potential_period_n_frames = beginning_period_end_frame - beginning_period_start_frame + 1)

fname_high_low_periods <- "Tables/high_low_periods.rds"
if (file.exists(fname_high_low_periods)) {
  high_low_periods.df <- readRDS(file = fname_high_low_periods)
} else {
  high_low_periods.list <- list()
  
  pb <- progress_bar$new(total = nrow(potential_frames.df))
  pb$tick(0)
    
  for (i_potential_duration in 1:nrow(potential_frames.df)) {
  # for (i_potential_duration in 1:3) {
  
    beg_period_strt_frm <- potential_frames.df$beginning_period_start_frame[i_potential_duration]
    beg_period_end_frm <- potential_frames.df$beginning_period_end_frame[i_potential_duration]
    end_period_strt_frm <- potential_frames.df$end_period_start_frame[i_potential_duration]
    end_period_end_frm <- potential_frames.df$end_period_end_frame[i_potential_duration]
    
    high_low_periods.list[[i_potential_duration]] <- 
      density_per_frame_tables_all.df %>% 
      mutate(beginning_end = ifelse(frame_num >= beg_period_strt_frm & 
                                      frame_num <= beg_period_end_frm, 
                                    "beginning", 
                                    ifelse(frame_num >= end_period_strt_frm & 
                                      frame_num <= end_period_end_frm, 
                                      "end", "none"))) %>% 
      filter(beginning_end != "none") %>% 
      group_by(i_dataset, trial_num, circle_num, beginning_end) %>% 
      reframe(period_n_frames_high = sum(density > density_threshold$median), 
              period_n_frames_low = sum(density < density_threshold$median), 
              period_n_frames_perc_high = period_n_frames_high/n(),
              period_n_frames_perc_low = period_n_frames_low/n()) %>% 
      mutate(potential_period_duration = 
               potential_frames.df$potential_period_durations[i_potential_duration], 
             potential_period_n_frames = 
               potential_frames.df$potential_period_n_frames[i_potential_duration])
    
    pb$tick()
  }
  
  high_low_periods.df <- bind_rows(high_low_periods.list)
  saveRDS(object = high_low_periods.df, file = fname_high_low_periods)
  write.csv(x = high_low_periods.df, file = gsub(".rds", ".csv", fname_high_low_periods))
}



```

```{r low-to-high-density-counts}
#| echo: false
#| include: false

high_low_periods_wide.df <- high_low_periods.df %>% 
  tidyr::pivot_wider(values_from = c(period_n_frames_high,
                                     period_n_frames_low, 
                                     period_n_frames_perc_high,
                                     period_n_frames_perc_low),
                     names_from = beginning_end, 
                     names_sep = "_") %>% 
  mutate(high_to_low_category = 
           ifelse(period_n_frames_perc_high_beginning == 1 &
                    period_n_frames_perc_low_end == 1, 
                  "high-to-low", 
                  ifelse(period_n_frames_perc_low_beginning == 1 &
                    period_n_frames_perc_high_end == 1, 
                    "low-to-high", "none"))) 
names(high_low_periods_wide.df) <- gsub("^period_", "", names(high_low_periods_wide.df))

count_high_low_trajectories_per_trial.df <- high_low_periods_wide.df %>% 
  group_by(i_dataset, potential_period_duration, trial_num) %>% 
  count(high_to_low_category, name = "n_trajectories")

count_trial_per_high_low_categories.df <- 
  count_high_low_trajectories_per_trial.df %>% 
  group_by(potential_period_duration, high_to_low_category, n_trajectories) %>% 
  count()

count_trial_per_high_low_categories_for_plot.df <-  
  count_trial_per_high_low_categories.df %>% 
  filter(high_to_low_category != "none") %>%
  # filter(n_trajectories %in% c(4,5)) %>% 
  mutate(n = ifelse(n > 50, 50, n), 
         n_trajectories = factor(n_trajectories, levels = n_trajectories)) 


```

```{r low-to-high-density-plot}
#| echo: false
#| include: false

count_trial_per_high_low_categories.plot <- ggplot() + 
  geom_line(data = count_trial_per_high_low_categories_for_plot.df, 
             aes(x = potential_period_duration, y = n, color = n_trajectories)) + 
  geom_point(data = count_trial_per_high_low_categories_for_plot.df, 
             aes(x = potential_period_duration, y = n)) + 
  facet_grid(high_to_low_category ~ .) + 
  geom_hline(yintercept = 10, color = "red", linetype = "dotted") + 
  geom_hline(yintercept = 5, color = "red", linetype = "solid")

count_trial_per_high_low_categories.plot
```

```{r low-to-high-density-plot-display}
#| echo: false
#| fig-cap: "Number of trials with a given number of trajetcories in the low-to-high and high-to-low categories for each period duration."
#| cap-location: margin
#| out.width: "70%"
#| fig.align: "center"

count_trial_per_high_low_categories.plot
```

## Potential Trials

```{r extract-trials-for-low-high-density}
#| echo: false
#| include: false

period_duration <- 1.4

trials_to_keep_for_low_to_high_density.df <- 
  count_high_low_trajectories_per_trial.df %>% 
  filter(n_trajectories >= n_targets_in_experiment) %>% 
  filter(potential_period_duration == period_duration) %>% 
  filter(high_to_low_category == "low-to-high") 
n_possible_trials_low_to_high <- nrow(trials_to_keep_for_low_to_high_density.df)

trials_to_keep_for_high_to_low_density.df <- 
  count_high_low_trajectories_per_trial.df %>% 
  filter(n_trajectories >= n_targets_in_experiment) %>% 
  filter(potential_period_duration == period_duration) %>% 
  filter(high_to_low_category == "high-to-low") 
n_possible_trials_high_to_low <- nrow(trials_to_keep_for_high_to_low_density.df)

```


It seems that the maximum period duration given that we want 5 trajectories per trial is `r period_duration` seconds (we may be able to go to higher values if we simulate more trials). 

And here are the trials we can pick from for the "low-to-high" and "high-to-low" condition trials. There are `r n_possible_trials_low_to_high` possible trials for the above condition and `r n_possible_trials_high_to_low` for the below condition.


```{r extract-trials-for-high-to-low-density-tbl}
#| echo: false
#| tbl-cap: "Trials with the right number of high-to-low trajectories"  
#| cap-location: top

knitr::kable(trials_to_keep_for_low_to_high_density.df, align = "c")
```

```{r extract-trials-for-low-to-high-density-tbl}
#| echo: false
#| tbl-cap: "Trials with the right number of low-to-high trajectories"  
#| cap-location: top

knitr::kable(trials_to_keep_for_high_to_low_density.df, align = "c")
```

# Target Density Low/High Throughout

## Finding sets of circles with low/high density with themselves

```{r compute-density-within-subsets-function}
#| echo: false
#| include: false
#| cache: true

# density_per_frame_tables_for_claude.df <- density_per_frame_tables_all.df %>% 
#   filter(trial_num <= 10, i_dataset == 1) %>% 
#   select(i_dataset, trial_num, frame_num, circle_num, x_coord, y_coord)
# write.csv(x = density_per_frame_tables_for_claude.df, 
#           file = "Tables/density_per_frame_table_for_claude.csv", 
#           row.names = F)

# ─────────────────────────────────────────────
# 1. Function
# ─────────────────────────────────────────────

compute_target_density <- function(data, target_set, start_frame, end_frame) {
  
  # Pre-filter to relevant frames for efficiency
  data_filtered <- data %>%
    filter(frame_num >= start_frame, 
           frame_num <= end_frame, 
           circle_num %in% target_set)
  
  # For each circle × frame in range, compute sum of distances to all target_set circles
  density_df <- data_filtered %>%
    group_by(i_dataset, trial_num, frame_num, circle_num) %>%
    group_modify(~ {
      if(!is.null(pb)) {
        pb$tick()
      }
      current_circle <- .x  # x, y of this circle
      
      # Get coordinates of all target_set circles in this trial × frame
      target_coords <- data_filtered %>%
        filter(i_dataset == .y$i_dataset,
               trial_num == .y$trial_num,
               frame_num  == .y$frame_num,
               circle_num %in% target_set)
      
      # Compute sum of Euclidean distances from this circle to each target circle
      target_density <- target_coords %>%
        mutate(dist = sqrt((x_coord - current_circle$x_coord)^2 +
                             (y_coord - current_circle$y_coord)^2)) %>%
        pull(dist) %>%
        sum()
      
      .x %>% mutate(target_density = target_density)
    }) %>%
    ungroup() %>% 
    mutate(
      target_set = paste(target_set, collapse = "-")
    )
  
  return(density_df)
}


compute_target_density_wrapper <- function(data, target_sets, start_frame, end_frame) {
  target_density_per_frame.list <- list()
  for (i_set in 1:length(target_sets)) {
    target_set <- target_sets[[i_set]]
    
    target_density_per_frame.list[[i_set]] <- compute_target_density(
      data        = data,
      target_set  = target_set,
      start_frame = start_frame,
      end_frame   = end_frame)
  }
  target_density_per_frame.df <- bind_rows(target_density_per_frame.list)
  return(target_density_per_frame.df)
}


```

```{r compute-density-within-subsets-parameters}
#| echo: false
#| include: false
#| cache: true

# ─────────────────────────────────────────────
# 2. Run for all target sets and combine
# ─────────────────────────────────────────────

target_sets <- list(
  c(1,2,3,4,5),
  c(6,7,8,9,10),
  c(11,12,13,14,15),
  c(1,3,5,7,9),
  c(11,13,15,16,1),
  c(2,4,6,8,10),
  c(12,14,16,1,2),
  c(3,6,9,12,15),
  c(4,7,10,13,16),
  c(2,5,8,11,14), 
  c(1,5,9,13,3),
  c(2,6,10,14,4),
  c(3,7,11,15,7),
  c(4,8,12,16,8),
  c(5,10,15,12,9),
  c(6,11,16,13,14)
)

n_target_sets <- length(unlist(target_sets))


start_frame <- 1
end_frame <- trial_n_frames  
n_frames <- (end_frame - start_frame + 1)


```

```{r compute-density-within-subsets-above-threshold-trials}
#| echo: false
#| include: false
#| cache: true

density_per_frame_tables_above_throughout.df <- 
  readRDS(file = "Tables/density_per_frame_tables_above_throughout.rds")
n_trials_above <- nrow(unique(density_per_frame_tables_above_throughout.df %>%
                                select(trial_num, i_dataset)))


start.time <- Sys.time()

pb <- progress_bar$new(total = n_target_sets * n_frames * n_trials_above)
pb$tick(0)
target_density_per_frame_tables_above_throughout.df <- 
  compute_target_density_wrapper(
    data = density_per_frame_tables_above_throughout.df, 
    target_sets = target_sets, 
    start_frame = start_frame, 
    end_frame = end_frame)

end.time <- Sys.time()
time.taken <- end.time - start.time
time.taken
time_for_target_set_per_trial <- time.taken / nrow(unique(density_per_frame_tables_for_claude.df %>% select(i_dataset, trial_num)))
time_for_target_set_per_trial

write.csv(target_density_per_frame_tables_above_throughout.df, 
          file = "Tables/target_density_per_frame_tables_above_throughout.csv", 
          row.names = F)
saveRDS(target_density_per_frame_tables_above_throughout.df, 
        file = "Tables/target_density_per_frame_tables_above_throughout.rds")


```

```{r compute-density-within-subsets-below-threshold-trials}
#| echo: false
#| include: false
#| cache: true

density_per_frame_tables_below_throughout.df <- 
  saveRDS(file = "Tables/density_per_frame_tables_below_throughout.rds")

n_trials_below <- nrow(unique(density_per_frame_tables_below_throughout.df %>%
                                       select(i_dataset, trial_num)))
pb <- progress_bar$new(total = n_target_sets * n_frames * n_trials_below)
pb$tick(0)
target_density_per_frame_tables_below_throughout.df <- 
  compute_target_density_wrapper(
    data = density_per_frame_tables_below_throughout.df, 
    target_sets = target_sets, 
    start_frame = start_frame, 
    end_frame = end_frame)


write.csv(target_density_per_frame_tables_below_throughout.df, 
          file = "Tables/target_density_per_frame_tables_below_throughout.csv", 
          row.names = F)
saveRDS(target_density_per_frame_tables_below_throughout.df, 
        file = "Tables/target_density_per_frame_tables_below_throughout.rds")


```

```{r find-trajectories-with}
#| echo: false
#| include: false
#| cache: true

# ─────────────────────────────────────────────
# 3. Summary stats collapsed across everything
# ─────────────────────────────────────────────

summary_stats <- combined_df %>%
  filter(!is.na(target_density)) %>%
  summarise(
    median_density = median(target_density),
    mean_density   = mean(target_density),
    sd_density     = sd(target_density)
  )

print(summary_stats)

```



